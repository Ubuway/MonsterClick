<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap & Top</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #7C3AED;
            --secondary: #10B981;
            --dark: #0F172A;
            --darker: #0A0F1C;
            --light: #F8FAFC;
            --accent: #F59E0B;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --skin-rare: #06D6A0;
            --skin-epic: #9D4EDD;
            --skin-legendary: #FF6B35;
            --skin-mythic: #FF006E;
            --energy: #3B82F6;
            --purple-dark: #5B21B6;
            --purple-light: #8B5CF6;
            --silver-color: #C0C0C0;
            --gold-color: #FFD700;
            --emerald-color: #00D9C9;
            --crystal-color: #C957FF;
            --csgo-bg: #121212;
            --csgo-container: #1E2028;
            --csgo-border: #2D3748;
            --csgo-highlight: #FFD700;
            --csgo-text: #E5E7EB;
            --csgo-rarity-common: #B0C3D9;
            --csgo-rarity-uncommon: #5E98D9;
            --csgo-rarity-rare: #4B69FF;
            --csgo-rarity-mythical: #8847FF;
            --csgo-rarity-legendary: #D32CE6;
            --csgo-rarity-ancient: #EB4B4B;
            --csgo-rarity-immortal: #E4AE39;
            --radius: 20px;
            --radius-sm: 12px;
            --radius-lg: 30px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'SF Pro Display', system-ui, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        body {
            background: linear-gradient(135deg, #0A0F1C 0%, #1E293B 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            touch-action: manipulation;
            padding-top: 140px;
            font-family: 'Inter', sans-serif;
        }
        
        /* СТИЛЬ CSGO */
        .csgo-container {
            background: linear-gradient(145deg, var(--csgo-container) 0%, #1A1C23 100%);
            border-radius: var(--radius);
            border: 1px solid var(--csgo-border);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .csgo-header {
            font-family: 'Radiance', 'Segoe UI', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--csgo-highlight);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--csgo-border);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .skin-card {
            background: linear-gradient(145deg, #2A2D38 0%, #1E2129 100%);
            border-radius: var(--radius-sm);
            border: 1px solid var(--csgo-border);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
        }
        
        .skin-card:hover {
            transform: translateY(-5px);
            border-color: var(--csgo-highlight);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
        }
        
        .skin-card.rare { border-color: var(--skin-rare); }
        .skin-card.epic { border-color: var(--skin-epic); }
        .skin-card.legendary { border-color: var(--skin-legendary); }
        .skin-card.mythic { border-color: var(--skin-mythic); }
        
        .skin-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--skin-rare) 0%, 
                var(--skin-epic) 33%, 
                var(--skin-legendary) 66%, 
                var(--skin-mythic) 100%);
            z-index: 2;
        }
        
        .skin-preview {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .skin-preview::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            animation: shine 3s infinite linear;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .skin-icon {
            font-size: 3.5rem;
            color: var(--csgo-highlight);
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }
        
        .skin-info {
            padding: 15px;
            background: rgba(26, 28, 35, 0.8);
        }
        
        .skin-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--csgo-text);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .skin-rarity {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .skin-rare .skin-rarity { background: rgba(6, 214, 160, 0.15); color: var(--skin-rare); }
        .skin-epic .skin-rarity { background: rgba(157, 78, 221, 0.15); color: var(--skin-epic); }
        .skin-legendary .skin-rarity { background: rgba(255, 107, 53, 0.15); color: var(--skin-legendary); }
        .skin-mythic .skin-rarity { background: rgba(255, 0, 110, 0.15); color: var(--skin-mythic); }
        
        .skin-price {
            font-size: 1rem;
            font-weight: 800;
            color: var(--gold-color);
            margin-top: 5px;
        }
        
        .skin-price span {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }
        
        .skin-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .skin-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .skin-btn-equip {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%);
            color: white;
        }
        
        .skin-btn-sell {
            background: linear-gradient(135deg, var(--gold-color) 0%, #CC8800 100%);
            color: white;
        }
        
        /* ЛИДЕРБОРД */
        .leaderboard-container {
            background: linear-gradient(145deg, var(--csgo-container) 0%, #1A1C23 100%);
            border-radius: var(--radius);
            border: 1px solid var(--csgo-border);
            overflow: hidden;
        }
        
        .leaderboard-header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--purple-dark) 100%);
            padding: 15px 20px;
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            text-align: center;
        }
        
        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--csgo-border);
            transition: background 0.3s;
        }
        
        .leaderboard-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .leaderboard-row.current-user {
            background: rgba(124, 58, 237, 0.15);
            border-left: 4px solid var(--primary);
        }
        
        .leaderboard-rank {
            width: 50px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--csgo-highlight);
        }
        
        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }
        
        .leaderboard-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            margin-right: 15px;
            border: 2px solid var(--csgo-border);
        }
        
        .leaderboard-info {
            flex: 1;
        }
        
        .leaderboard-name {
            font-weight: 700;
            color: var(--csgo-text);
            margin-bottom: 3px;
        }
        
        .leaderboard-stats {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .leaderboard-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--gold-color);
            min-width: 100px;
            text-align: right;
        }
        
        /* МАГАЗИН */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .shop-item {
            background: linear-gradient(145deg, #2A2D38 0%, #1E2129 100%);
            border-radius: var(--radius-sm);
            border: 1px solid var(--csgo-border);
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }
        
        .shop-item-header {
            margin-bottom: 15px;
        }
        
        .shop-item-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--csgo-highlight);
        }
        
        .shop-item-name {
            font-weight: 700;
            color: var(--csgo-text);
            font-size: 1.1rem;
        }
        
        .shop-item-price {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--gold-color);
            margin: 15px 0;
        }
        
        .shop-item-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        /* РЫНОК */
        .market-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--csgo-container);
            padding: 10px;
            border-radius: var(--radius-sm);
        }
        
        .market-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: 1px solid var(--csgo-border);
            border-radius: var(--radius-sm);
            color: var(--csgo-text);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .market-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%);
            border-color: var(--primary);
            color: white;
        }
        
        .market-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 10px 15px;
            background: var(--csgo-container);
            border: 1px solid var(--csgo-border);
            border-radius: var(--radius-sm);
            color: var(--csgo-text);
            font-weight: 600;
            cursor: pointer;
            min-width: 150px;
        }
        
        /* ОБЩИЕ СТИЛИ (остаются из предыдущего кода) */
        .compact-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, 
                rgba(15, 23, 42, 0.98) 0%, 
                rgba(10, 15, 28, 0.98) 100%);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            border-bottom: 1px solid rgba(124, 58, 237, 0.3);
            height: 60px;
            backdrop-filter: blur(20px);
        }
        
        /* ... остальные стили из предыдущего кода ... */
        
        /* МОБИЛЬНАЯ АДАПТАЦИЯ */
        @media (max-width: 768px) {
            body {
                padding-top: 120px;
            }
            
            .compact-header {
                height: 50px;
                padding: 8px 10px;
            }
            
            .shop-grid,
            .market-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .skin-actions {
                flex-direction: column;
            }
            
            .market-filters {
                flex-direction: column;
            }
            
            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- АНТИ-АВТОКЛИК БЛОКИРОВКА -->
    <div id="cheatBlockOverlay" class="cheat-block-overlay">
        <div class="cheat-warning">Обнаружен авто-кликер!</div>
        <div class="cheat-details">
            В целях безопасности мы вынуждены вас временно заблокировать на 1 минуту.<br>
            При последующем использовании авто-кликера будет выдан постоянный бан.
        </div>
        <div class="cheat-timer" id="cheatTimer">01:00</div>
    </div>
    
    <!-- 3D МОДЕЛИ ЛУТБОКСОВ -->
    <div id="lootbox3DContainer" class="lootbox-3d-container">
        <canvas id="lootboxCanvas" class="lootbox-canvas"></canvas>
        <div class="lootbox-controls">
            <button id="openLootbox3D" class="lootbox-btn">
                <i class="fas fa-gift"></i> Открыть
            </button>
            <button id="closeLootbox3D" class="lootbox-btn" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                <i class="fas fa-times"></i> Закрыть
            </button>
        </div>
    </div>
    
    <!-- МОДАЛЬНОЕ ОКНО ПРЕДМЕТОВ -->
    <div id="itemModal" class="csgo-container" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; max-width: 500px; width: 90%; display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 id="modalTitle" style="color: var(--csgo-highlight); font-size: 1.5rem;"></h3>
            <button onclick="game.closeModal()" style="background: transparent; border: none; color: var(--csgo-text); font-size: 1.5rem; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalContent"></div>
    </div>
    <div id="modalOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 9998; display: none;"></div>
    
    <!-- ОСНОВНОЙ ИНТЕРФЕЙС -->
    <div id="gameContainer">
        <!-- ХЕДЕР С ВАЛЮТАМИ -->
        <header class="compact-header">
            <div class="logo-container" style="display: flex; align-items: center; gap: 10px;">
                <div class="logo-icon" style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;">
                    <i class="fas fa-hand-pointer"></i>
                </div>
                <div class="logo-text" style="font-size: 1.3rem; font-weight: 800; color: white;">Tap & Top</div>
            </div>
            
            <div class="resources-container" style="display: flex; gap: 15px; align-items: center;">
                <!-- SILVER -->
                <div class="currency-display" style="display: flex; align-items: center; gap: 8px;">
                    <div class="currency-icon" style="width: 30px; height: 30px; background: linear-gradient(135deg, var(--silver-color) 0%, #808080 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-coins" style="color: white;"></i>
                    </div>
                    <div class="currency-info">
                        <div class="currency-amount" id="silverAmount" style="font-size: 1.1rem; font-weight: 800; color: white;">0</div>
                    </div>
                </div>
                
                <!-- GOLD -->
                <div class="currency-display" style="display: flex; align-items: center; gap: 8px;">
                    <div class="currency-icon" style="width: 30px; height: 30px; background: linear-gradient(135deg, var(--gold-color) 0%, #CC8800 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-gem" style="color: white;"></i>
                    </div>
                    <div class="currency-info">
                        <div class="currency-amount" id="goldAmount" style="font-size: 1.1rem; font-weight: 800; color: white;">0</div>
                    </div>
                </div>
                
                <!-- ЭНЕРГИЯ -->
                <div class="energy-display" style="display: flex; align-items: center; gap: 8px;">
                    <div class="energy-info" style="display: flex; align-items: center; gap: 5px; color: white; font-weight: 600;">
                        <i class="fas fa-bolt"></i>
                        <span id="energyValue">100/100</span>
                    </div>
                    <div class="energy-bar" style="width: 80px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                        <div class="energy-fill" id="energyFill" style="height: 100%; background: linear-gradient(90deg, var(--energy) 0%, #1D4ED8 100%); width: 100%;"></div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- ВЕРХНЕЕ МЕНЮ -->
        <nav class="top-menu">
            <button class="top-menu-btn active" data-tab="clicker">
                <i class="fas fa-fist-raised"></i> Тапалка
            </button>
            <button class="top-menu-btn" data-tab="inventory">
                <i class="fas fa-box"></i> Инвентарь
            </button>
            <button class="top-menu-btn" data-tab="shop">
                <i class="fas fa-store"></i> Магазин
            </button>
            <button class="top-menu-btn" data-tab="market">
                <i class="fas fa-exchange-alt"></i> Рынок
            </button>
            <button class="top-menu-btn" data-tab="leaderboard">
                <i class="fas fa-trophy"></i> Лидерборд
            </button>
            <button class="top-menu-btn" data-tab="buffs">
                <i class="fas fa-arrow-up"></i> Баффы
            </button>
        </nav>
        
        <!-- ОСНОВНОЙ КОНТЕНТ -->
        <main class="main-content" id="mainContent">
            <!-- Контент будет загружаться динамически -->
        </main>
        
        <!-- ФУТЕР -->
        <footer class="footer" style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(10, 15, 28, 0.98) 100%); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(124, 58, 237, 0.3); backdrop-filter: blur(20px); z-index: 999;">
            <div class="footer-info" style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                <strong style="color: white;">Tap & Top</strong> © 2024 | Уровень: <span id="currentLevel">1</span> | Equipped: <span id="equippedSkin">Default</span>
            </div>
            
            <div class="footer-actions">
                <button class="action-button" id="saveGameBtn" style="padding: 8px 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer;">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </footer>
    </div>
    
    <!-- УВЕДОМЛЕНИЯ -->
    <div class="notification-container" id="notificationContainer"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';

        // ============ 3D МОДЕЛИ ЛУТБОКСОВ ============
        class Lootbox3DViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.currentModel = null;
                this.currentType = null;
                this.lights = [];
                this.animationId = null;
            }
            
            init(canvasId) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                // Создаем сцену
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0a0a0a);
                
                // Камера
                this.camera = new THREE.PerspectiveCamera(40, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                this.camera.position.set(-7, 3, 9);
                
                // Рендерер
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas,
                    antialias: true, 
                    alpha: true,
                    powerPreference: "high-performance"
                });
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.6;
                this.renderer.outputEncoding = THREE.sRGBEncoding;
                
                // Управление
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.autoRotate = true;
                this.controls.dampingFactor = 0.05;
                this.controls.minDistance = 3;
                this.controls.maxDistance = 30;
                this.controls.maxPolarAngle = Math.PI / 1.9;
                this.controls.minPolarAngle = Math.PI / 6;
                this.controls.autoRotateSpeed = 1.0;
                
                // Запускаем анимацию
                this.animate();
                
                // Ресайз
                window.addEventListener('resize', () => this.onResize());
            }
            
            show(type) {
                this.currentType = type;
                document.getElementById('lootbox3DContainer').classList.add('active');
                this.loadModel(type);
            }
            
            hide() {
                document.getElementById('lootbox3DContainer').classList.remove('active');
                if (this.currentModel) {
                    this.scene.remove(this.currentModel);
                    this.currentModel = null;
                }
            }
            
            loadModel(type) {
                // Очищаем предыдущую модель
                if (this.currentModel) {
                    this.scene.remove(this.currentModel);
                }
                
                // Очищаем свет
                this.lights.forEach(light => this.scene.remove(light));
                this.lights = [];
                
                // Создаем модель в зависимости от типа
                this.currentModel = this.createModel(type);
                this.scene.add(this.currentModel);
                
                // Настраиваем освещение
                this.setupLights(type);
                
                // Сбрасываем камеру
                this.camera.position.set(-7, 3, 9);
                this.controls.reset();
            }
            
            createModel(type) {
                const group = new THREE.Group();
                
                // Цвета в зависимости от типа
                let mainColor, darkColor;
                switch(type) {
                    case 'silver':
                        mainColor = 0xE0E0E0;
                        darkColor = 0xA0A0A0;
                        break;
                    case 'gold':
                        mainColor = 0xFFD166;
                        darkColor = 0xCC8800;
                        break;
                    case 'emerald':
                        mainColor = 0x00D9C9;
                        darkColor = 0x008A7A;
                        break;
                    case 'crystal':
                        mainColor = 0xC957FF;
                        darkColor = 0x9B30CC;
                        break;
                }
                
                // Материалы
                const caseMaterial = new THREE.MeshPhysicalMaterial({
                    color: mainColor,
                    metalness: 1.0,
                    roughness: 0.12,
                    clearcoat: 0.9,
                    clearcoatRoughness: 0.08,
                    reflectivity: 1.2,
                    envMapIntensity: 2.5,
                    emissive: darkColor,
                    emissiveIntensity: 0.15,
                    specularColor: mainColor,
                    specularIntensity: 1.2,
                    ior: 2.0,
                    sheen: 0.5,
                    sheenRoughness: 0.3,
                    sheenColor: mainColor
                });
                
                const latchMaterial = new THREE.MeshPhysicalMaterial({ 
                    color: darkColor,
                    metalness: 1.0,
                    roughness: 0.15,
                    clearcoat: 0.95,
                    clearcoatRoughness: 0.1,
                    envMapIntensity: 2.2,
                    emissive: darkColor,
                    emissiveIntensity: 0.1,
                    specularColor: darkColor,
                    specularIntensity: 1.0,
                    ior: 2.2,
                    sheen: 0.4,
                    sheenRoughness: 0.4,
                    sheenColor: darkColor
                });
                
                // Основная часть кейса
                const mainBody = new THREE.Mesh(
                    new RoundedBoxGeometry(4.5, 2.2, 2.8, 4, 0.18),
                    caseMaterial
                );
                mainBody.castShadow = mainBody.receiveShadow = true;
                group.add(mainBody);
                
                // Верхняя часть
                const topPart = new THREE.Mesh(
                    new RoundedBoxGeometry(4.6, 0.6, 2.9, 4, 0.12),
                    caseMaterial
                );
                topPart.position.y = 1.4;
                topPart.castShadow = topPart.receiveShadow = true;
                group.add(topPart);
                
                // Вертикальные ребра
                for(let i = -1.8; i <= 1.8; i += 0.9) {
                    const edgeFront = new THREE.Mesh(
                        new RoundedBoxGeometry(0.26, 2.2, 0.2, 2, 0.06),
                        caseMaterial
                    );
                    edgeFront.position.set(i, 0, 1.42);
                    edgeFront.castShadow = edgeFront.receiveShadow = true;
                    group.add(edgeFront);
                    
                    const edgeBack = new THREE.Mesh(
                        new RoundedBoxGeometry(0.26, 2.2, 0.2, 2, 0.06),
                        caseMaterial
                    );
                    edgeBack.position.set(i, 0, -1.42);
                    edgeBack.castShadow = edgeBack.receiveShadow = true;
                    group.add(edgeBack);
                }
                
                // Замки
                function createRoundedLatch(x) {
                    const latchGroup = new THREE.Group();
                    
                    const base = new THREE.Mesh(
                        new RoundedBoxGeometry(0.5, 0.8, 0.15, 2, 0.04),
                        latchMaterial
                    );
                    
                    const detail = new THREE.Mesh(
                        new RoundedBoxGeometry(0.4, 0.3, 0.1, 2, 0.03),
                        latchMaterial
                    );
                    detail.position.y = -0.2;
                    detail.position.z = 0.12;
                    
                    latchGroup.add(base, detail);
                    latchGroup.position.set(x, 1.05, 1.45);
                    return latchGroup;
                }
                
                group.add(createRoundedLatch(-1.3));
                group.add(createRoundedLatch(1.3));
                
                // Ручка
                const handle = new THREE.Mesh(
                    new RoundedBoxGeometry(0.15, 0.15, 1, 2, 0.04),
                    latchMaterial
                );
                handle.position.set(2.3, 0.28, 0);
                handle.castShadow = handle.receiveShadow = true;
                group.add(handle);
                
                return group;
            }
            
            setupLights(type) {
                // Цвет освещения в зависимости от типа
                let lightColor;
                switch(type) {
                    case 'silver':
                        lightColor = 0xFFFFFF;
                        break;
                    case 'gold':
                        lightColor = 0xFFD700;
                        break;
                    case 'emerald':
                        lightColor = 0x00E6D6;
                        break;
                    case 'crystal':
                        lightColor = 0xC957FF;
                        break;
                }
                
                // Окружающий свет
                const ambientLight = new THREE.AmbientLight(lightColor, 1.8);
                this.scene.add(ambientLight);
                this.lights.push(ambientLight);
                
                // Основной направленный свет
                const mainLight = new THREE.DirectionalLight(lightColor, 3.5);
                mainLight.position.copy(this.camera.position);
                mainLight.castShadow = true;
                this.scene.add(mainLight);
                this.lights.push(mainLight);
                
                // Точечные огни
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    const distance = 12;
                    const x = Math.cos(angle) * distance;
                    const z = Math.sin(angle) * distance;
                    const y = 3 + Math.sin(angle * 2) * 2;
                    
                    const pointLight = new THREE.PointLight(lightColor, 2.5, 25);
                    pointLight.position.set(x, y, z);
                    this.scene.add(pointLight);
                    this.lights.push(pointLight);
                }
            }
            
            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
                
                if (this.currentModel) {
                    // Легкое вращение модели
                    this.currentModel.rotation.y += 0.005;
                }
                
                if (this.controls) {
                    this.controls.update();
                }
                
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
            
            onResize() {
                const canvas = this.renderer.domElement;
                this.camera.aspect = canvas.clientWidth / canvas.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
            
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                if (this.renderer) {
                    this.renderer.dispose();
                }
            }
        }

        // ============ ДВИЖОК ИГРЫ TAP & TOP ============
        class TapTopEngine {
            constructor() {
                // АНТИ-АВТОКЛИК СИСТЕМА
                this.antiCheat = {
                    enabled: true,
                    maxCPS: 20,
                    clickHistory: [],
                    suspiciousPatterns: 0,
                    isBlocked: false,
                    blockTime: 0,
                    warnings: 0,
                    maxWarnings: 2,
                    banDuration: 60000,
                    permanentBan: false
                };
                
                // 3D ВЬЮЕР
                this.lootbox3DViewer = null;
                
                // СИСТЕМА СКИНОВ
                this.skinsData = {
                    'default': {
                        id: 'default',
                        name: 'Default Clicker',
                        rarity: 'common',
                        price: 0,
                        sellPrice: 0,
                        icon: 'fas fa-hand-pointer',
                        color: '#7C3AED',
                        powerMultiplier: 1.0
                    },
                    'silver_dragon': {
                        id: 'silver_dragon',
                        name: 'Silver Dragon',
                        rarity: 'rare',
                        price: 1000,
                        sellPrice: 250,
                        icon: 'fas fa-dragon',
                        color: '#C0C0C0',
                        powerMultiplier: 1.2
                    },
                    'golden_phoenix': {
                        id: 'golden_phoenix',
                        name: 'Golden Phoenix',
                        rarity: 'epic',
                        price: 5000,
                        sellPrice: 1250,
                        icon: 'fas fa-fire',
                        color: '#FFD700',
                        powerMultiplier: 1.5
                    },
                    'emerald_knight': {
                        id: 'emerald_knight',
                        name: 'Emerald Knight',
                        rarity: 'legendary',
                        price: 25000,
                        sellPrice: 6250,
                        icon: 'fas fa-shield-alt',
                        color: '#00D9C9',
                        powerMultiplier: 2.0
                    },
                    'crystal_king': {
                        id: 'crystal_king',
                        name: 'Crystal King',
                        rarity: 'mythic',
                        price: 100000,
                        sellPrice: 25000,
                        icon: 'fas fa-crown',
                        color: '#C957FF',
                        powerMultiplier: 3.0
                    },
                    'neon_cyber': {
                        id: 'neon_cyber',
                        name: 'Neon Cyber',
                        rarity: 'rare',
                        price: 1500,
                        sellPrice: 375,
                        icon: 'fas fa-bolt',
                        color: '#00FF88',
                        powerMultiplier: 1.3
                    },
                    'lava_fury': {
                        id: 'lava_fury',
                        name: 'Lava Fury',
                        rarity: 'epic',
                        price: 7500,
                        sellPrice: 1875,
                        icon: 'fas fa-volcano',
                        color: '#FF6B35',
                        powerMultiplier: 1.8
                    },
                    'cosmic_void': {
                        id: 'cosmic_void',
                        name: 'Cosmic Void',
                        rarity: 'legendary',
                        price: 50000,
                        sellPrice: 12500,
                        icon: 'fas fa-globe-americas',
                        color: '#8B5CF6',
                        powerMultiplier: 2.5
                    }
                };
                
                // ЛИДЕРБОРД (тестовые данные)
                this.leaderboardData = [
                    { id: 'player_1', nickname: 'ProPlayer', avatar: 'PP', level: 150, silver: 2500000, gold: 5000 },
                    { id: 'player_2', nickname: 'TapMaster', avatar: 'TM', level: 128, silver: 1800000, gold: 3200 },
                    { id: 'player_3', nickname: 'GoldHunter', avatar: 'GH', level: 115, silver: 1200000, gold: 2400 },
                    { id: 'player_4', nickname: 'SilverLord', avatar: 'SL', level: 98, silver: 850000, gold: 1500 },
                    { id: 'player_5', nickname: 'ClickGod', avatar: 'CG', level: 82, silver: 620000, gold: 1100 },
                    { id: 'player_6', nickname: 'BuffKing', avatar: 'BK', level: 75, silver: 480000, gold: 850 },
                    { id: 'player_7', nickname: 'SkinCollector', avatar: 'SC', level: 68, silver: 350000, gold: 600 },
                    { id: 'player_8', nickname: 'LootboxOpener', avatar: 'LO', level: 55, silver: 220000, gold: 400 },
                    { id: 'player_9', nickname: 'BeginnerPro', avatar: 'BP', level: 42, silver: 150000, gold: 250 },
                    { id: 'player_10', nickname: 'NewPlayer', avatar: 'NP', level: 25, silver: 80000, gold: 120 }
                ];
                
                // Игровые данные
                this.gameData = {
                    playerId: this.generatePlayerId(),
                    nickname: 'Игрок_' + Math.floor(Math.random() * 1000),
                    avatar: 'TT',
                    
                    // ВАЛЮТЫ
                    silver: 10000,
                    gold: 100,
                    
                    // ИГРОК
                    level: 1,
                    experience: 0,
                    maxExperience: 1000,
                    baseClickPower: 1,
                    totalClicks: 0,
                    
                    // ЭНЕРГИЯ
                    energy: 100,
                    maxEnergy: 100,
                    energyCost: 0.5,
                    energyRegen: 0.1,
                    
                    // АКТИВНЫЕ БАФФЫ
                    activeBuffs: [],
                    
                    // ИНВЕНТАРЬ
                    inventory: {
                        silver_lootbox: 5,
                        gold_lootbox: 2,
                        emerald_lootbox: 1,
                        crystal_lootbox: 0,
                        skins: ['default']
                    },
                    
                    // СКИНЫ
                    skins: ['default'],
                    equippedSkin: 'default',
                    
                    // ДОСТИЖЕНИЯ
                    achievements: [],
                    
                    // РЫНОК
                    marketListings: [],
                    
                    // СТАТИСТИКА
                    stats: {
                        sessionStart: Date.now(),
                        totalTime: 0,
                        totalSilverEarned: 0,
                        totalGoldEarned: 0,
                        buffsUsed: 0,
                        skinsOwned: 1,
                        lootboxesOpened: 0,
                        itemsSold: 0
                    }
                };
                
                // СИСТЕМА БАФФОВ
                this.buffsData = [
                    {
                        id: 'click_x2',
                        name: 'Усиление ×2',
                        description: 'Увеличивает силу клика в 2 раза',
                        type: 'click_power',
                        multiplier: 2,
                        duration: 30,
                        price: { silver: 1000 },
                        icon: 'fas fa-arrow-up',
                        color: '#3B82F6'
                    },
                    {
                        id: 'click_x3',
                        name: 'Усиление ×3',
                        description: 'Увеличивает силу клика в 3 раза',
                        type: 'click_power',
                        multiplier: 3,
                        duration: 25,
                        price: { silver: 2500 },
                        icon: 'fas fa-arrow-up',
                        color: '#8B5CF6'
                    },
                    {
                        id: 'click_x5',
                        name: 'Эпическое Усиление ×5',
                        description: 'Увеличивает силу клика в 5 раз',
                        type: 'click_power',
                        multiplier: 5,
                        duration: 20,
                        price: { silver: 10000 },
                        icon: 'fas fa-arrow-up',
                        color: '#7C3AED'
                    }
                ];
                
                // Инициализация
                this.init();
                this.generateMarketListings();
            }
            
            generatePlayerId() {
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substring(2, 8);
                return `TT_${timestamp}_${random}`.toUpperCase();
            }
            
            init() {
                this.setupEventListeners();
                this.init3DViewer();
                this.startGameLoop();
                this.loadGame();
                
                // Запускаем игру
                this.currentTab = 'clicker';
                this.loadTabContent('clicker');
                this.updateUI();
                
                // Автосохранение
                setInterval(() => this.saveGame(false), 30000);
            }
            
            init3DViewer() {
                // Инициализируем 3D вьюер после загрузки страницы
                setTimeout(() => {
                    this.lootbox3DViewer = new Lootbox3DViewer();
                    this.lootbox3DViewer.init('lootboxCanvas');
                    
                    // Вешаем обработчики на кнопки 3D вьюера
                    document.getElementById('openLootbox3D').addEventListener('click', () => {
                        this.openLootbox3D();
                    });
                    
                    document.getElementById('closeLootbox3D').addEventListener('click', () => {
                        this.lootbox3DViewer.hide();
                    });
                }, 1000);
            }
            
            setupEventListeners() {
                // Верхнее меню
                document.addEventListener('click', (e) => {
                    const menuBtn = e.target.closest('.top-menu-btn');
                    if (menuBtn) {
                        const tab = menuBtn.dataset.tab;
                        this.switchTab(tab);
                    }
                });
                
                // Кнопка сохранения
                document.getElementById('saveGameBtn').addEventListener('click', () => this.saveGame());
            }
            
            handleClick(event) {
                if (this.antiCheat.isBlocked) return;
                if (!this.checkAntiCheat(event)) return;
                if (this.gameData.energy < this.gameData.energyCost) {
                    this.showNotification('Недостаточно энергии!', 'warning');
                    return;
                }
                
                this.gameData.energy -= this.gameData.energyCost;
                
                // Базовая сила клика
                let clickPower = this.gameData.baseClickPower;
                
                // Модификатор от скина
                const skinData = this.skinsData[this.gameData.equippedSkin];
                if (skinData) {
                    clickPower *= skinData.powerMultiplier;
                }
                
                // Баффы
                this.gameData.activeBuffs.forEach(buff => {
                    if (buff.type === 'click_power' && buff.active) {
                        clickPower *= buff.multiplier;
                    }
                });
                
                let silverEarned = clickPower;
                this.gameData.activeBuffs.forEach(buff => {
                    if (buff.type === 'silver_multiplier' && buff.active) {
                        silverEarned *= buff.multiplier;
                    }
                });
                
                silverEarned = Math.floor(silverEarned);
                this.gameData.silver += silverEarned;
                this.gameData.totalClicks++;
                this.gameData.stats.totalSilverEarned += silverEarned;
                
                this.gameData.experience += Math.floor(silverEarned / 10);
                if (this.gameData.experience >= this.gameData.maxExperience) {
                    this.levelUp();
                }
                
                this.createClickEffect(event, silverEarned, false);
                this.updateUI();
            }
            
            checkAntiCheat(event) {
                if (!this.antiCheat.enabled) return true;
                
                const now = Date.now();
                this.antiCheat.clickHistory = this.antiCheat.clickHistory.filter(
                    time => now - time < 1000
                );
                
                this.antiCheat.clickHistory.push(now);
                const cps = this.antiCheat.clickHistory.length;
                
                if (cps > this.antiCheat.maxCPS) {
                    this.antiCheat.suspiciousPatterns++;
                    if (this.antiCheat.suspiciousPatterns > 5) {
                        this.blockForCheating();
                        return false;
                    }
                    if (this.antiCheat.warnings === 0) {
                        this.showNotification('Предупреждение: Подозрительная активность!', 'warning');
                        this.antiCheat.warnings++;
                    }
                } else {
                    this.antiCheat.suspiciousPatterns = Math.max(0, this.antiCheat.suspiciousPatterns - 1);
                }
                
                return true;
            }
            
            blockForCheating() {
                if (this.antiCheat.permanentBan) return;
                
                this.antiCheat.isBlocked = true;
                this.antiCheat.blockTime = Date.now() + this.antiCheat.banDuration;
                this.antiCheat.warnings++;
                
                const overlay = document.getElementById('cheatBlockOverlay');
                const timer = document.getElementById('cheatTimer');
                overlay.classList.add('active');
                
                const updateTimer = () => {
                    if (!this.antiCheat.isBlocked) return;
                    
                    const remaining = Math.max(0, this.antiCheat.blockTime - Date.now());
                    const seconds = Math.floor(remaining / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    
                    timer.textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    
                    if (remaining > 0) {
                        setTimeout(updateTimer, 1000);
                    } else {
                        this.unblockCheating();
                    }
                };
                
                updateTimer();
                
                if (this.antiCheat.warnings >= 3) {
                    this.antiCheat.permanentBan = true;
                    document.querySelector('.cheat-details').innerHTML = 
                        'Вы получили <strong>ПЕРМАНЕНТНЫЙ БАН</strong> за использование авто-кликера!';
                    timer.textContent = 'НАВСЕГДА';
                }
                
                this.saveGame(false);
            }
            
            unblockCheating() {
                this.antiCheat.isBlocked = false;
                this.antiCheat.suspiciousPatterns = 0;
                document.getElementById('cheatBlockOverlay').classList.remove('active');
                this.showNotification('Блокировка снята. Играйте честно!', 'info');
            }
            
            createClickEffect(event, amount, isCritical) {
                const monster = document.querySelector('.monster-display');
                if (!monster) return;
                
                const rect = monster.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                const popup = document.createElement('div');
                popup.className = 'money-popup';
                popup.textContent = '+' + amount;
                popup.style.color = isCritical ? '#EF4444' : '#FFD700';
                popup.style.left = x + 'px';
                popup.style.top = y + 'px';
                monster.appendChild(popup);
                setTimeout(() => popup.remove(), 1000);
                
                monster.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    monster.style.transform = 'scale(1)';
                }, 100);
            }
            
            switchTab(tab) {
                document.querySelectorAll('.top-menu-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                this.currentTab = tab;
                this.loadTabContent(tab);
                
                setTimeout(() => {
                    this.attachMonsterListeners();
                }, 100);
            }
            
            attachMonsterListeners() {
                const monsterDisplay = document.querySelector('.monster-display');
                if (monsterDisplay) {
                    monsterDisplay.onmousedown = (e) => this.handleClick(e);
                    monsterDisplay.ontouchstart = (e) => {
                        e.preventDefault();
                        this.handleClick(e);
                    };
                }
            }
            
            loadTabContent(tab) {
                const content = document.getElementById('mainContent');
                
                switch(tab) {
                    case 'clicker':
                        content.innerHTML = this.renderClicker();
                        this.attachMonsterListeners();
                        break;
                    case 'buffs':
                        content.innerHTML = this.renderBuffs();
                        break;
                    case 'inventory':
                        content.innerHTML = this.renderInventory();
                        break;
                    case 'shop':
                        content.innerHTML = this.renderShop();
                        break;
                    case 'market':
                        content.innerHTML = this.renderMarket();
                        break;
                    case 'leaderboard':
                        content.innerHTML = this.renderLeaderboard();
                        break;
                }
                
                this.updateUI();
            }
            
            renderClicker() {
                const skinData = this.skinsData[this.gameData.equippedSkin];
                const progress = (this.gameData.experience / this.gameData.maxExperience * 100).toFixed(1);
                
                return `
                    <div class="clicker-section">
                        <div class="csgo-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 class="csgo-header">TAP TO EARN</h2>
                                <div style="display: flex; gap: 10px;">
                                    <div style="background: rgba(124, 58, 237, 0.1); padding: 8px 15px; border-radius: 20px; border: 1px solid var(--csgo-border);">
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Equipped Skin</div>
                                        <div style="font-size: 1rem; font-weight: 700; color: ${skinData.color};">
                                            ${skinData.name}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: center;">
                                <div class="monster-display" style="width: 250px; height: 250px; margin: 0 auto 20px; position: relative; cursor: pointer;">
                                    <div class="monster" style="width: 100%; height: 100%; border-radius: 50%; position: relative; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; font-size: 5rem; color: white; background: linear-gradient(135deg, ${skinData.color} 0%, ${this.darkenColor(skinData.color, 20)} 100%);">
                                        <i class="${skinData.icon}"></i>
                                    </div>
                                </div>
                                
                                <div style="color: rgba(255, 255, 255, 0.7); margin: 20px 0;">
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                        <div style="text-align: center; padding: 15px; background: rgba(30, 41, 59, 0.5); border-radius: 10px;">
                                            <div style="font-size: 1.3rem; font-weight: 800; color: var(--silver-color);">
                                                ${this.formatNumber(this.gameData.silver)}
                                            </div>
                                            <div style="font-size: 0.8rem;">Silver</div>
                                        </div>
                                        
                                        <div style="text-align: center; padding: 15px; background: rgba(30, 41, 59, 0.5); border-radius: 10px;">
                                            <div style="font-size: 1.3rem; font-weight: 800; color: var(--gold-color);">
                                                ${this.formatNumber(this.gameData.gold)}
                                            </div>
                                            <div style="font-size: 0.8rem;">Gold</div>
                                        </div>
                                        
                                        <div style="text-align: center; padding: 15px; background: rgba(30, 41, 59, 0.5); border-radius: 10px;">
                                            <div style="font-size: 1.3rem; font-weight: 800; color: ${skinData.color};">
                                                x${skinData.powerMultiplier}
                                            </div>
                                            <div style="font-size: 0.8rem;">Skin Boost</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(30, 41, 59, 0.3); padding: 15px; border-radius: 10px; margin-top: 20px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span style="color: rgba(255, 255, 255, 0.7);">
                                            <i class="fas fa-bolt"></i> Энергия
                                        </span>
                                        <span style="font-weight: 700; color: white;">
                                            ${Math.floor(this.gameData.energy)}/${this.gameData.maxEnergy}
                                        </span>
                                    </div>
                                    <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; background: linear-gradient(90deg, var(--energy) 0%, #1D4ED8 100%); width: ${(this.gameData.energy / this.gameData.maxEnergy * 100)}%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderInventory() {
                // Отображаем скины
                let skinsHTML = '';
                this.gameData.skins.forEach(skinId => {
                    const skin = this.skinsData[skinId];
                    if (skin) {
                        const isEquipped = this.gameData.equippedSkin === skin.id;
                        skinsHTML += `
                            <div class="skin-card skin-${skin.rarity}" data-skin="${skin.id}">
                                <div class="skin-preview" style="background: linear-gradient(135deg, ${this.hexToRgb(skin.color, 0.3)} 0%, rgba(15, 23, 42, 0.9) 100%);">
                                    <i class="${skin.icon} skin-icon"></i>
                                    ${isEquipped ? `
                                        <div style="position: absolute; top: 10px; right: 10px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700;">
                                            EQUIPPED
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="skin-info">
                                    <div class="skin-name">${skin.name}</div>
                                    <div class="skin-rarity">${skin.rarity.toUpperCase()}</div>
                                    <div class="skin-price">${this.formatNumber(skin.sellPrice)} <span>Gold</span></div>
                                    <div class="skin-actions">
                                        <button class="skin-btn skin-btn-equip" onclick="game.equipSkin('${skin.id}')" ${isEquipped ? 'disabled' : ''}>
                                            <i class="fas fa-check"></i> ${isEquipped ? 'Надет' : 'Надеть'}
                                        </button>
                                        <button class="skin-btn skin-btn-sell" onclick="game.sellSkin('${skin.id}')" ${skin.id === 'default' ? 'disabled' : ''}>
                                            <i class="fas fa-coins"></i> Продать
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Отображаем лутбоксы
                let lootboxesHTML = '';
                Object.keys(this.gameData.inventory).forEach(itemId => {
                    if (itemId.includes('lootbox') && this.gameData.inventory[itemId] > 0) {
                        const count = this.gameData.inventory[itemId];
                        const type = itemId.split('_')[0];
                        const colors = {
                            'silver': '#C0C0C0',
                            'gold': '#FFD700',
                            'emerald': '#00D9C9',
                            'crystal': '#C957FF'
                        };
                        const color = colors[type];
                        
                        lootboxesHTML += `
                            <div style="background: rgba(30, 41, 59, 0.9); border-radius: 12px; padding: 15px; text-align: center; position: relative;">
                                <div style="position: absolute; top: -5px; right: -5px; background: var(--primary); color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75rem;">
                                    ${count}
                                </div>
                                <div style="font-size: 2.5rem; margin-bottom: 10px; color: ${color}">
                                    <i class="fas fa-${type === 'silver' ? 'box' : type === 'gold' ? 'box-open' : type === 'emerald' ? 'gem' : 'crown'}"></i>
                                </div>
                                <div style="font-size: 0.9rem; color: white; margin-bottom: 5px;">
                                    ${type.toUpperCase()} Лутбокс
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 5px;">
                                    <button onclick="game.showLootbox3D('${type}')"
                                            style="flex: 1; padding: 8px; background: ${color}; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        <i class="fas fa-eye"></i> 3D
                                    </button>
                                    <button onclick="game.openLootbox('${itemId}')"
                                            style="flex: 1; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                        <i class="fas fa-gift"></i> Открыть
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
                
                return `
                    <div style="margin-top: 20px;">
                        <div class="csgo-container">
                            <h2 class="csgo-header">
                                <i class="fas fa-box"></i> ИНВЕНТАРЬ
                            </h2>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: var(--csgo-highlight); margin-bottom: 15px; font-size: 1.3rem;">
                                    <i class="fas fa-palette"></i> СКИНЫ
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                                    ${skinsHTML || `
                                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.5);">
                                            <i class="fas fa-palette" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                            <div>Нет скинов</div>
                                            <div style="font-size: 0.9rem; margin-top: 10px;">Купите скины в магазине!</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--csgo-highlight); margin-bottom: 15px; font-size: 1.3rem;">
                                    <i class="fas fa-gift"></i> ЛУТБОКСЫ
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                                    ${lootboxesHTML || `
                                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.5);">
                                            <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                            <div>Нет лутбоксов</div>
                                            <div style="font-size: 0.9rem; margin-top: 10px;">Купите лутбоксы в магазине!</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderShop() {
                // Лутбоксы
                const lootboxes = [
                    {
                        id: 'silver_lootbox',
                        name: 'Серебряный Лутбокс',
                        price: { silver: 10000 },
                        icon: 'fas fa-box',
                        color: '#C0C0C0',
                        description: 'Шанс получить обычные и редкие скины'
                    },
                    {
                        id: 'gold_lootbox',
                        name: 'Золотой Лутбокс',
                        price: { silver: 50000 },
                        icon: 'fas fa-box-open',
                        color: '#FFD700',
                        description: 'Шанс получить эпические скины'
                    },
                    {
                        id: 'emerald_lootbox',
                        name: 'Изумрудный Лутбокс',
                        price: { gold: 50 },
                        icon: 'fas fa-gem',
                        color: '#00D9C9',
                        description: 'Шанс получить легендарные скины'
                    },
                    {
                        id: 'crystal_lootbox',
                        name: 'Кристальный Лутбокс',
                        price: { gold: 500 },
                        icon: 'fas fa-crown',
                        color: '#C957FF',
                        description: 'Шанс получить мифические скины'
                    }
                ];
                
                let lootboxesHTML = '';
                lootboxes.forEach(lootbox => {
                    const canAfford = lootbox.price.silver ? 
                        this.gameData.silver >= lootbox.price.silver : 
                        this.gameData.gold >= lootbox.price.gold;
                    
                    lootboxesHTML += `
                        <div class="shop-item">
                            <div class="shop-item-header">
                                <div class="shop-item-icon" style="color: ${lootbox.color};">
                                    <i class="${lootbox.icon}"></i>
                                </div>
                                <div class="shop-item-name">${lootbox.name}</div>
                            </div>
                            <div class="shop-item-price">
                                ${lootbox.price.silver ? 
                                    `${this.formatNumber(lootbox.price.silver)} Silver` : 
                                    `${this.formatNumber(lootbox.price.gold)} Gold`}
                            </div>
                            <div class="shop-item-description">
                                ${lootbox.description}
                            </div>
                            <button onclick="game.buyLootbox('${lootbox.id}')" 
                                    style="width: 100%; padding: 12px; background: ${canAfford ? `linear-gradient(135deg, ${lootbox.color} 0%, ${this.darkenColor(lootbox.color, 20)} 100%)` : '#4A5568'}; border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer;"
                                    ${!canAfford ? 'disabled' : ''}>
                                <i class="fas fa-shopping-cart"></i> Купить
                            </button>
                        </div>
                    `;
                });
                
                // Скины
                let skinsShopHTML = '';
                Object.values(this.skinsData).forEach(skin => {
                    if (skin.id !== 'default' && !this.gameData.skins.includes(skin.id)) {
                        const canAfford = this.gameData.gold >= skin.price;
                        skinsShopHTML += `
                            <div class="skin-card skin-${skin.rarity}">
                                <div class="skin-preview" style="background: linear-gradient(135deg, ${this.hexToRgb(skin.color, 0.3)} 0%, rgba(15, 23, 42, 0.9) 100%);">
                                    <i class="${skin.icon} skin-icon"></i>
                                </div>
                                <div class="skin-info">
                                    <div class="skin-name">${skin.name}</div>
                                    <div class="skin-rarity">${skin.rarity.toUpperCase()}</div>
                                    <div class="skin-price">${this.formatNumber(skin.price)} <span>Gold</span></div>
                                    <div class="skin-actions">
                                        <button class="skin-btn skin-btn-equip" onclick="game.buySkin('${skin.id}')" ${!canAfford ? 'disabled' : ''}>
                                            <i class="fas fa-shopping-cart"></i> Купить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                return `
                    <div style="margin-top: 20px;">
                        <div class="csgo-container">
                            <h2 class="csgo-header">
                                <i class="fas fa-store"></i> МАГАЗИН
                            </h2>
                            
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: var(--csgo-highlight); margin-bottom: 15px; font-size: 1.3rem;">
                                    <i class="fas fa-gift"></i> ЛУТБОКСЫ
                                </h3>
                                <div class="shop-grid">
                                    ${lootboxesHTML}
                                </div>
                            </div>
                            
                            <div>
                                <h3 style="color: var(--csgo-highlight); margin-bottom: 15px; font-size: 1.3rem;">
                                    <i class="fas fa-palette"></i> СКИНЫ
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                                    ${skinsShopHTML || `
                                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.5);">
                                            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                            <div>Все скины куплены!</div>
                                            <div style="font-size: 0.9rem; margin-top: 10px;">Вы владеете всеми доступными скинами</div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderMarket() {
                let marketHTML = '';
                
                // Активные предложения
                if (this.gameData.marketListings.length > 0) {
                    this.gameData.marketListings.forEach((listing, index) => {
                        const skin = this.skinsData[listing.skinId];
                        if (skin) {
                            marketHTML += `
                                <div class="skin-card skin-${skin.rarity}">
                                    <div class="skin-preview" style="background: linear-gradient(135deg, ${this.hexToRgb(skin.color, 0.3)} 0%, rgba(15, 23, 42, 0.9) 100%);">
                                        <i class="${skin.icon} skin-icon"></i>
                                    </div>
                                    <div class="skin-info">
                                        <div class="skin-name">${skin.name}</div>
                                        <div class="skin-rarity">${skin.rarity.toUpperCase()}</div>
                                        <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 5px;">
                                            Продавец: ${listing.seller}
                                        </div>
                                        <div class="skin-price">${this.formatNumber(listing.price)} <span>Gold</span></div>
                                        <div class="skin-actions">
                                            <button class="skin-btn skin-btn-equip" onclick="game.buyFromMarket(${index})" ${this.gameData.gold >= listing.price ? '' : 'disabled'}>
                                                <i class="fas fa-shopping-cart"></i> Купить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    marketHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 50px; color: rgba(255, 255, 255, 0.5);">
                            <i class="fas fa-exchange-alt" style="font-size: 4rem; margin-bottom: 20px;"></i>
                            <div style="font-size: 1.2rem;">Рынок пуст</div>
                            <div style="margin-top: 10px;">Продайте скины чтобы они появились здесь!</div>
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-top: 20px;">
                        <div class="csgo-container">
                            <h2 class="csgo-header">
                                <i class="fas fa-exchange-alt"></i> РЫНОК
                            </h2>
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                                <select class="filter-select" id="marketFilterRarity">
                                    <option value="all">Все редкости</option>
                                    <option value="rare">Rare</option>
                                    <option value="epic">Epic</option>
                                    <option value="legendary">Legendary</option>
                                    <option value="mythic">Mythic</option>
                                </select>
                                
                                <select class="filter-select" id="marketFilterSort">
                                    <option value="price_asc">Цена: по возрастанию</option>
                                    <option value="price_desc">Цена: по убыванию</option>
                                    <option value="rarity">Редкость</option>
                                </select>
                                
                                <button class="skin-btn skin-btn-equip" onclick="game.refreshMarket()" style="padding: 10px 20px;">
                                    <i class="fas fa-sync-alt"></i> Обновить
                                </button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                                ${marketHTML}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderLeaderboard() {
                let leaderboardHTML = '';
                
                // Добавляем текущего игрока в лидерборд
                const playerEntry = {
                    id: this.gameData.playerId,
                    nickname: this.gameData.nickname,
                    avatar: this.gameData.avatar,
                    level: this.gameData.level,
                    silver: this.gameData.silver,
                    gold: this.gameData.gold
                };
                
                const allPlayers = [...this.leaderboardData, playerEntry].sort((a, b) => b.level - a.level);
                
                allPlayers.forEach((player, index) => {
                    const isCurrentUser = player.id === this.gameData.playerId;
                    leaderboardHTML += `
                        <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                            <div class="leaderboard-rank rank-${index + 1}">
                                ${index + 1}
                            </div>
                            <div class="leaderboard-avatar">
                                ${player.avatar}
                            </div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">
                                    ${player.nickname} ${isCurrentUser ? '(Вы)' : ''}
                                </div>
                                <div class="leaderboard-stats">
                                    Level ${player.level} | Silver: ${this.formatNumber(player.silver)}
                                </div>
                            </div>
                            <div class="leaderboard-value">
                                ${this.formatNumber(player.gold)} Gold
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div style="margin-top: 20px;">
                        <div class="leaderboard-container">
                            <div class="leaderboard-header">
                                <i class="fas fa-trophy"></i> ЛИДЕРБОРД
                            </div>
                            ${leaderboardHTML}
                        </div>
                    </div>
                `;
            }
            
            renderBuffs() {
                let buffsHTML = '';
                
                this.buffsData.forEach(buff => {
                    const canAfford = this.gameData.silver >= buff.price.silver;
                    
                    buffsHTML += `
                        <div style="background: rgba(30, 41, 59, 0.9); border-radius: 16px; padding: 20px; border: 2px solid ${buff.color}; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, ${buff.color} 0%, #1D4ED8 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white;">
                                    <i class="${buff.icon}"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 1.2rem; font-weight: 800; color: white;">${buff.name}</div>
                                    <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">${buff.description}</div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6);">Длительность</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--energy);">${buff.duration} сек</div>
                                </div>
                                
                                <div style="text-align: center;">
                                    <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6);">Цена</div>
                                    <div style="font-size: 1rem; font-weight: 700; color: var(--silver-color);">${this.formatNumber(buff.price.silver)} Silver</div>
                                </div>
                            </div>
                            
                            <button onclick="game.activateBuff('${buff.id}')" 
                                    style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--primary) 0%, var(--purple-dark) 100%); border: none; border-radius: 8px; color: white; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;"
                                    ${!canAfford ? 'disabled' : ''}>
                                <i class="fas fa-bolt"></i> Активировать
                            </button>
                        </div>
                    `;
                });
                
                return `
                    <div style="margin-top: 20px;">
                        <div class="csgo-container">
                            <h2 class="csgo-header">
                                <i class="fas fa-arrow-up"></i> БАФФЫ
                            </h2>
                            ${buffsHTML}
                        </div>
                    </div>
                `;
            }
            
            // ============ СИСТЕМА СКИНОВ ============
            equipSkin(skinId) {
                if (!this.skinsData[skinId]) return;
                if (!this.gameData.skins.includes(skinId)) return;
                
                this.gameData.equippedSkin = skinId;
                this.showNotification(`Скин "${this.skinsData[skinId].name}" надет!`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            buySkin(skinId) {
                const skin = this.skinsData[skinId];
                if (!skin) return;
                
                if (this.gameData.gold < skin.price) {
                    this.showNotification('Недостаточно Gold!', 'warning');
                    return;
                }
                
                this.gameData.gold -= skin.price;
                if (!this.gameData.skins.includes(skinId)) {
                    this.gameData.skins.push(skinId);
                    this.gameData.stats.skinsOwned++;
                }
                
                this.showNotification(`Скин "${skin.name}" куплен!`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            sellSkin(skinId) {
                const skin = this.skinsData[skinId];
                if (!skin) return;
                if (skinId === 'default') return;
                if (!this.gameData.skins.includes(skinId)) return;
                if (this.gameData.equippedSkin === skinId) {
                    this.showNotification('Сначала снимите скин!', 'warning');
                    return;
                }
                
                // Удаляем скин из инвентаря
                const index = this.gameData.skins.indexOf(skinId);
                if (index > -1) {
                    this.gameData.skins.splice(index, 1);
                }
                
                // Даем Gold
                this.gameData.gold += skin.sellPrice;
                this.gameData.stats.itemsSold++;
                
                // Создаем предложение на рынке (цена на 20% выше)
                const marketPrice = Math.floor(skin.sellPrice * 1.2);
                this.gameData.marketListings.push({
                    skinId: skinId,
                    seller: this.gameData.nickname,
                    price: marketPrice,
                    timestamp: Date.now()
                });
                
                this.showNotification(`Скин "${skin.name}" продан на рынок за ${marketPrice} Gold!`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            buyFromMarket(listingIndex) {
                if (listingIndex >= this.gameData.marketListings.length) return;
                
                const listing = this.gameData.marketListings[listingIndex];
                const skin = this.skinsData[listing.skinId];
                
                if (!skin) return;
                if (this.gameData.gold < listing.price) {
                    this.showNotification('Недостаточно Gold!', 'warning');
                    return;
                }
                
                // Покупаем
                this.gameData.gold -= listing.price;
                if (!this.gameData.skins.includes(listing.skinId)) {
                    this.gameData.skins.push(listing.skinId);
                    this.gameData.stats.skinsOwned++;
                }
                
                // Удаляем предложение
                this.gameData.marketListings.splice(listingIndex, 1);
                
                this.showNotification(`Скин "${skin.name}" куплен с рынка!`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            generateMarketListings() {
                // Генерируем тестовые предложения
                if (this.gameData.marketListings.length === 0) {
                    const skins = Object.values(this.skinsData).filter(s => s.id !== 'default');
                    for (let i = 0; i < 5; i++) {
                        const randomSkin = skins[Math.floor(Math.random() * skins.length)];
                        const price = Math.floor(randomSkin.sellPrice * (1 + Math.random() * 0.5));
                        this.gameData.marketListings.push({
                            skinId: randomSkin.id,
                            seller: ['Trader_Pro', 'SkinKing', 'MarketLord', 'GoldMaster', 'SilverTrader'][i],
                            price: price,
                            timestamp: Date.now() - Math.random() * 86400000
                        });
                    }
                }
            }
            
            refreshMarket() {
                this.generateMarketListings();
                this.loadTabContent('market');
                this.showNotification('Рынок обновлен!', 'info');
            }
            
            // ============ СИСТЕМА ЛУТБОКСОВ ============
            buyLootbox(lootboxType) {
                const lootboxes = {
                    'silver_lootbox': { price: { silver: 10000 } },
                    'gold_lootbox': { price: { silver: 50000 } },
                    'emerald_lootbox': { price: { gold: 50 } },
                    'crystal_lootbox': { price: { gold: 500 } }
                };
                
                const lootbox = lootboxes[lootboxType];
                if (!lootbox) return;
                
                if (lootbox.price.silver && this.gameData.silver < lootbox.price.silver) {
                    this.showNotification('Недостаточно Silver!', 'warning');
                    return;
                }
                
                if (lootbox.price.gold && this.gameData.gold < lootbox.price.gold) {
                    this.showNotification('Недостаточно Gold!', 'warning');
                    return;
                }
                
                if (lootbox.price.silver) {
                    this.gameData.silver -= lootbox.price.silver;
                } else {
                    this.gameData.gold -= lootbox.price.gold;
                }
                
                this.gameData.inventory[lootboxType]++;
                
                this.showNotification('Лутбокс куплен! Проверьте инвентарь.', 'success');
                this.updateUI();
                this.saveGame();
            }
            
            openLootbox(lootboxType) {
                if (this.gameData.inventory[lootboxType] <= 0) {
                    this.showNotification('У вас нет этого лутбокса!', 'error');
                    return;
                }
                
                this.gameData.inventory[lootboxType]--;
                this.gameData.stats.lootboxesOpened++;
                
                // Определяем тип лутбокса
                const type = lootboxType.split('_')[0];
                let rewards = [];
                
                switch(type) {
                    case 'silver':
                        rewards = this.generateSilverLootboxRewards();
                        break;
                    case 'gold':
                        rewards = this.generateGoldLootboxRewards();
                        break;
                    case 'emerald':
                        rewards = this.generateEmeraldLootboxRewards();
                        break;
                    case 'crystal':
                        rewards = this.generateCrystalLootboxRewards();
                        break;
                }
                
                // Применяем награды
                rewards.forEach(reward => {
                    if (reward.type === 'silver') {
                        this.gameData.silver += reward.amount;
                        this.showNotification(`Получено: ${this.formatNumber(reward.amount)} Silver!`, 'success');
                    } else if (reward.type === 'gold') {
                        this.gameData.gold += reward.amount;
                        this.showNotification(`Получено: ${this.formatNumber(reward.amount)} Gold!`, 'success');
                    } else if (reward.type === 'skin' && this.skinsData[reward.skin]) {
                        if (!this.gameData.skins.includes(reward.skin)) {
                            this.gameData.skins.push(reward.skin);
                            this.gameData.stats.skinsOwned++;
                            this.showNotification(`Получен скин: ${this.skinsData[reward.skin].name}!`, 'success');
                        } else {
                            this.gameData.gold += Math.floor(this.skinsData[reward.skin].sellPrice * 0.5);
                            this.showNotification(`Дубликат скина! Получено: ${Math.floor(this.skinsData[reward.skin].sellPrice * 0.5)} Gold`, 'info');
                        }
                    }
                });
                
                this.updateUI();
                this.saveGame();
            }
            
            generateSilverLootboxRewards() {
                const rewards = [];
                const silverReward = Math.floor(1000 + Math.random() * 9000);
                rewards.push({ type: 'silver', amount: silverReward });
                
                // 30% шанс на скин
                if (Math.random() < 0.3) {
                    const availableSkins = Object.values(this.skinsData)
                        .filter(s => s.rarity === 'rare' && !this.gameData.skins.includes(s.id));
                    if (availableSkins.length > 0) {
                        const skin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                        rewards.push({ type: 'skin', skin: skin.id });
                    }
                }
                
                return rewards;
            }
            
            generateGoldLootboxRewards() {
                const rewards = [];
                const silverReward = Math.floor(5000 + Math.random() * 45000);
                rewards.push({ type: 'silver', amount: silverReward });
                
                // 50% шанс на скин
                if (Math.random() < 0.5) {
                    const availableSkins = Object.values(this.skinsData)
                        .filter(s => (s.rarity === 'rare' || s.rarity === 'epic') && !this.gameData.skins.includes(s.id));
                    if (availableSkins.length > 0) {
                        const skin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                        rewards.push({ type: 'skin', skin: skin.id });
                    }
                }
                
                return rewards;
            }
            
            generateEmeraldLootboxRewards() {
                const rewards = [];
                const goldReward = Math.floor(10 + Math.random() * 90);
                rewards.push({ type: 'gold', amount: goldReward });
                
                // 70% шанс на скин
                if (Math.random() < 0.7) {
                    const availableSkins = Object.values(this.skinsData)
                        .filter(s => (s.rarity === 'epic' || s.rarity === 'legendary') && !this.gameData.skins.includes(s.id));
                    if (availableSkins.length > 0) {
                        const skin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                        rewards.push({ type: 'skin', skin: skin.id });
                    }
                }
                
                return rewards;
            }
            
            generateCrystalLootboxRewards() {
                const rewards = [];
                const goldReward = Math.floor(50 + Math.random() * 450);
                rewards.push({ type: 'gold', amount: goldReward });
                
                // 90% шанс на скин
                if (Math.random() < 0.9) {
                    const availableSkins = Object.values(this.skinsData)
                        .filter(s => (s.rarity === 'legendary' || s.rarity === 'mythic') && !this.gameData.skins.includes(s.id));
                    if (availableSkins.length > 0) {
                        const skin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                        rewards.push({ type: 'skin', skin: skin.id });
                    }
                }
                
                return rewards;
            }
            
            showLootbox3D(type) {
                if (this.lootbox3DViewer) {
                    this.lootbox3DViewer.show(type);
                }
            }
            
            openLootbox3D() {
                if (!this.lootbox3DViewer.currentType) return;
                
                const lootboxType = this.lootbox3DViewer.currentType + '_lootbox';
                this.openLootbox(lootboxType);
                this.lootbox3DViewer.hide();
            }
            
            // ============ ОБЩИЕ ФУНКЦИИ ============
            activateBuff(buffId) {
                const buff = this.buffsData.find(b => b.id === buffId);
                if (!buff) return;
                
                if (this.gameData.silver < buff.price.silver) {
                    this.showNotification('Недостаточно Silver!', 'warning');
                    return;
                }
                
                this.gameData.silver -= buff.price.silver;
                
                const activeBuff = {
                    ...buff,
                    active: true,
                    expires: Date.now() + (buff.duration * 1000),
                    activatedAt: Date.now()
                };
                
                this.gameData.activeBuffs.push(activeBuff);
                this.gameData.stats.buffsUsed++;
                
                this.showNotification(`Активирован бафф: ${buff.name}!`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            levelUp() {
                this.gameData.level++;
                this.gameData.experience = 0;
                this.gameData.maxExperience = Math.floor(1000 * Math.pow(1.5, this.gameData.level - 1));
                this.gameData.baseClickPower += 0.1;
                
                const levelReward = this.gameData.level * 100;
                this.gameData.silver += levelReward;
                
                this.showNotification(`Уровень ${this.gameData.level}!<br>+${levelReward} Silver<br>+0.1 к силе клика`, 'success');
                this.updateUI();
                this.saveGame();
            }
            
            updateUI() {
                document.getElementById('silverAmount').textContent = this.formatNumber(this.gameData.silver);
                document.getElementById('goldAmount').textContent = this.formatNumber(this.gameData.gold);
                document.getElementById('currentLevel').textContent = this.gameData.level;
                document.getElementById('equippedSkin').textContent = this.skinsData[this.gameData.equippedSkin].name;
                
                const energyPercent = (this.gameData.energy / this.gameData.maxEnergy) * 100;
                document.getElementById('energyFill').style.width = energyPercent + '%';
                document.getElementById('energyValue').textContent = `${Math.floor(this.gameData.energy)}/${this.gameData.maxEnergy}`;
            }
            
            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('itemModal').style.display = 'block';
                document.getElementById('modalOverlay').style.display = 'block';
            }
            
            closeModal() {
                document.getElementById('itemModal').style.display = 'none';
                document.getElementById('modalOverlay').style.display = 'none';
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 20px;
                    background: ${type === 'success' ? '#10B981' : 
                                type === 'warning' ? '#F59E0B' : 
                                type === 'error' ? '#EF4444' : '#3B82F6'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    z-index: 10000;
                    transform: translateX(120%);
                    transition: transform 0.3s;
                    max-width: 300px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                `;
                
                notification.innerHTML = `
                    <div style="font-weight: 700; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                          type === 'warning' ? 'exclamation-triangle' : 
                                          type === 'error' ? 'times-circle' : 'info-circle'}"></i>
                        ${type === 'success' ? 'Успех!' : 
                         type === 'warning' ? 'Внимание!' : 
                         type === 'error' ? 'Ошибка!' : 'Информация'}
                    </div>
                    <div style="font-size: 0.9rem;">${message}</div>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 10);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(120%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
            
            startGameLoop() {
                setInterval(() => {
                    // Восстановление энергии
                    let regenRate = this.gameData.energyRegen;
                    this.gameData.activeBuffs.forEach(buff => {
                        if (buff.type === 'energy_regen' && buff.active) {
                            regenRate *= buff.multiplier;
                        }
                    });
                    
                    this.gameData.energy = Math.min(
                        this.gameData.maxEnergy, 
                        this.gameData.energy + regenRate
                    );
                    
                    // Удаляем прошедшие баффы
                    const now = Date.now();
                    this.gameData.activeBuffs = this.gameData.activeBuffs.filter(buff => buff.expires > now);
                    
                    this.updateUI();
                    
                }, 1000);
            }
            
            loadGame() {
                try {
                    const saved = localStorage.getItem('taptop_save_v2');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.version === '2.0') {
                            this.gameData = { ...this.gameData, ...data.gameData };
                            this.antiCheat = { ...this.antiCheat, ...data.antiCheat };
                            this.updateUI();
                            
                            if (this.antiCheat.isBlocked && this.antiCheat.blockTime > Date.now()) {
                                this.blockForCheating();
                            } else if (this.antiCheat.isBlocked) {
                                this.unblockCheating();
                            }
                        }
                    }
                } catch (e) {
                    console.log('Нет сохраненной игры');
                }
            }
            
            saveGame(showNotification = true) {
                try {
                    const saveData = {
                        version: '2.0',
                        timestamp: Date.now(),
                        gameData: this.gameData,
                        antiCheat: this.antiCheat
                    };
                    
                    localStorage.setItem('taptop_save_v2', JSON.stringify(saveData));
                    
                    if (showNotification) {
                        this.showNotification('Игра сохранена!', 'success');
                    }
                } catch (e) {
                    this.showNotification('Ошибка сохранения игры', 'error');
                }
            }
            
            formatNumber(num) {
                if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
                if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return Math.floor(num).toLocaleString();
            }
            
            hexToRgb(hex, alpha = 1) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            darkenColor(color, percent) {
                const num = parseInt(color.replace('#', ''), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return `#${(0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1)}`;
            }
        }

        // Инициализация игры
        document.addEventListener('DOMContentLoaded', function() {
            window.game = new TapTopEngine();
            console.log('Tap & Top готов!');
        });
    </script>
</body>
</html>